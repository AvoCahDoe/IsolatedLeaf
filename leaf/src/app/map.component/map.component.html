<div class="map-wrapper" role="region" aria-label="Interactive map">
  <!-- Map Container -->
  <div 
    class="map-container" 
    [class.blurred]="isLoading"
    [matContextMenuTriggerFor]="contextMenu"
    role="application"
    aria-label="Map display area">
  </div>

  <!-- Loading Overlay -->
  <div 
    class="loading-overlay" 
    [class.show]="isLoading"
    role="status"
    aria-live="polite">
    <mat-spinner diameter="60"></mat-spinner>
    <div class="loading-text">Loading map...</div>
    <p class="sub-text">Please wait</p>
  </div>

  <!-- Legend Toggle Button -->
  <button 
    mat-icon-button 
    (click)="toggleLegend()"
    [disabled]="isLoading"
    aria-label="Toggle map legend"
    title="Toggle legend">
    <mat-icon>{{ isLegendVisible ? 'check_box' : 'check_box_outline_blank' }}</mat-icon>
  </button>

  <!-- Filter Button with Menu -->
  <button 
    mat-icon-button 
    [matMenuTriggerFor]="filterMenu"
    [disabled]="isLoading"
    aria-label="Filter markers by type"
    title="Filter markers">
    <mat-icon>filter_list</mat-icon>
  </button>

  <!-- Filter Menu -->
  <mat-menu #filterMenu="matMenu" class="filter-menu">
    <button mat-menu-item (click)="setFilter('All')" [class.active]="filterLabel === 'All'">
      All Markers
    </button>
    @for (label of uniqueLabels; track label) {
      <button 
        mat-menu-item 
        (click)="setFilter(label)"
        [class.active]="filterLabel === label">
        {{ label  }}
      </button>
    }
  </mat-menu>

  <!-- Context Menu -->
  <mat-menu #contextMenu="matMenu" class="context-menu">
    <button mat-menu-item (click)="toggleLegend()" [disabled]="isLoading">
      <mat-icon>{{ isLegendVisible ? 'check_box' : 'check_box_outline_blank' }}</mat-icon>
      Toggle Legend
    </button>
    <button mat-menu-item [matMenuTriggerFor]="filterSubMenu" [disabled]="isLoading">
      <mat-icon>filter_list</mat-icon>
      Filter by Type
    </button>
  </mat-menu>

  <!-- Context Menu Filter Submenu -->
  <mat-menu #filterSubMenu="matMenu" class="filter-menu">
    <button mat-menu-item (click)="setFilter('All')" [class.active]="filterLabel === 'All'">
      All Markers
    </button>
    @for (label of uniqueLabels; track label) {
      <button 
        mat-menu-item 
        (click)="setFilter(label)"
        [class.active]="filterLabel === label">
        {{ label }}
      </button>
    }
  </mat-menu>
</div>